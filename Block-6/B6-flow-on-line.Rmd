# Flows on the line {#flow-on-line}

<div style="float:right;">[![](www/icons/edit.png)](https://github.com/ProjectMOSAIC/MOSAIC-Calculus/blob/main/Block-6/B6-fixed-points.Rmd)</div>



The previous two chapters presented ideas relating to dynamical systems: state, state-space, dynamical function, flow, trajectory, "solution." Now we turn to the some of the phenomena seen in dynamical systems, starting in the simplest way possible: dynamical systems with a single state variable. We'll focus on ***fixed points*** and their ***stability***, which can be understood qualitatively (although you need to distinguish between a positive and a negative slope). Then we'll look at a technique we have encountered since Block 2: approximation of a function by a straight-line function. Such linear dynamics have a straightforward exponential "solution."

Finally, we'll look at an important example of how careful observation of fixed points and the way dynamics change when we modify a parameter in the dynamical functions provides an understanding of a ecological stability and instability and the consequences that result.

## Dynamical function and flow

In the previous chapter, we saw how to draw a ***flow field*** in a two-dimensional state space, evaluating the dynamical functions and using the results to construct a vector. We can't practically visualize **both** the flow and the shapes of the two dynamical functions in a single plot, which makes it harder to understand structures such as fixed points.

Happily, with a one-dimensional state space, we can easily show both the flow vectors *and* the single dynamical function at once. 

For ease of reference, we'll name the dynamical function for the rest of this section $f(x)$, so that the differential equation is $$\partial_t x = f(x)\ .$$

The flow itself appears as the example in Figure \@ref(fig:phase-line-intro). The state space is the number line and the flow vectors are, as usual arrows that point from place to place in the state space.

```{r phase-line-intro, echo=FALSE, fig.cap="A one-dimensional state space shown with its flow vectors."}
raw <- rfun( ~ x, seed=920)
Znotes::phase_line(raw(x) - 2 ~ x, domain(x=-4:4),
                   nix_dyn=TRUE, narrows=25,
                   transform=function(x) x^.75) 
```
Because the state space can be drawn without using the vertical coordinate of the page, we can use that vertical coordinate to show something else: the dynamical function, as in Figure \@ref(fig:phase-line-intro2).

```{r phase-line-intro2, echo=FALSE, fig.cap="A one-dimensional state space shown with its flow vectors."}
raw <- rfun( ~ x, seed=920)
Znotes::phase_line(raw(x) - 2 ~ x, domain(x=-4:4), 
                   nix_dyn=FALSE, 
                   narrows=15, 
                   transform=function(x) x^.75) 
```

The correspondence between the dynamical function and the flow field is easy to see in such a presentation. Where the output of the dynamical is large and positive (say, near $x=0$), the flow is in the positive direction and relatively fast, as shown by a long, right-pointing flow vector. When the output of the dynamical function is negative (around $x=3$, for instance) the flow is in the negative direction: a left pointing arrow.

Near a zero crossing of the dynamical function, the flow arrows are negligibly short: the state velocity is very slow. Indeed, at the zero crossings, the state velocity is exactly zero. Such zero crossings are called ***fixed points***: since the state velocity is zero, the state never moves!

We can see the dynamics near fixed points more closely by zooming in, as in Figure \@ref(fig:phase-line-intro3) which shows two of the system's fixed points.

```{r phase-line-intro3, echo=FALSE, fig.cap="Zooming in on the flow for the system shown in Figure \\@ref(fig:phase-line-intro2)."}
raw <- rfun( ~ x, seed=920)
Znotes::phase_line(raw(x) - 2 ~ x, domain(x=-3.5:-1.25), 
                   nix_dyn=FALSE, 
                   narrows=15, 
                   transform=function(x) x^.75) 
```
Notice in Figure \@ref(fig:phase-line-intro3) that the flow is slower the nearer the state is to the fixed point, but it is only exactly zero at the fixed point.

A calculus technique you will be familiar with from previous Blocks is zooming in a region that we want to examine in detail. 

```{r phase-line-zoom1, echo=FALSE, fig.cap="Zooming in closely on each of the fixed points seen in Figure \\@ref(fig:phase-line-intro3).", out.width="50%", fig.show="keep"}
raw <- rfun( ~ x, seed=920)
Znotes::phase_line(raw(x) - 2 ~ x, domain(x=-3.07:-3.05), 
                   nix_dyn=FALSE, 
                   narrows=15, 
                   transform=function(x) x^1.03) 
Znotes::phase_line(raw(x) - 2 ~ x, domain(x=-1.59:-1.58), 
                   nix_dyn=FALSE, 
                   narrows=15, 
                   transform=function(x) x^1.03) 
```

The short pieces of the dynamical function shown in Figure \@ref(fig:phase-line-zoom1), are, like short pieces of any continuous function: almost exactly straight lines. For the left fixed point, the dynamical function is $f(x) \approx -2.804 (x + 3.055)$ while for the right it is $f(x) \approx 5.065 (x + 1.586)$. In Section \@ref(symbolic-solutions-ODE) we found symbolically the solutions for dynamical functions in this form. 
For $x_0\approx-3.055$ the solution is  $$x(t) \approx (x_0 + 3.055)e^{-2.804 t} - 3.055\ ,$$ while for $x_0\approx -1.586$ the solution is $$x(t) \approx (x_0 +1.586)\, e^{5.065 t} - 1.586\ .$$
There is something fundamentally different about these two solutions. One of them is exponential decay toward the fixed point, while the other grows exponentially away from the fixed point. We call the dynamics near the fixed-point with exponential decay ***stable*** and the dynamics near fixed-point with exponential growth ***unstable***.

::: {.takenote data-latex=""}
Graphics such as Figure \@ref(fig:phase-line-intro2) let you see both the flow and the dynamical functions together in one place. 

How about also showing trajectories? Unfortunately, the two-dimensional extent of a computer screen or a piece of paper make it hard to include still more information in an intelligible way. It would be nice to have a third dimension for the display.

Major Austin Davis developed such a display, using ***time*** as the third dimension. In the movie below, the state space is shown as a horizontal line, as before. The vertical axis shows the dynamical function as in Figure \@ref(fig:phase-line-intro2). The dynamical function is shown in another way: as the hue and intensity of color, which lets you focus on the activity in the state space. This activity is shown by the moving yellow triangles. Each triangle is placed on the phase line to mark an initial condition, then moves right or left according to the dynamics.

<video controls width="500">
    <source src="www/Stability-Animation.mp4"
            type="video/mp4">

    Sorry, your browser doesn't support mp4 videos.
</video>
:::

## Generic behavior

So long as two dynamical systems  have similar fixed points with the same stability, their trajectories will be much the same. For example, our model dynamical function might be  different in detail, as in Figure \@ref(fig:phase-line-random), and still produce the same behavior.

```{r phase-line-random, echo=FALSE, fig.cap="The dynamical function shown in black is a distortion of $f(x)$ from the previous plots. Yet the flow field is practically identical and leads to the same outcomes as $f(x)$ for any initial condition."}
Pts <- tibble::tibble(x=seq(-4,4,length=100),
                      y=rnorm(length(x))/2)
raw <- rfun( ~ x, seed=920)
Znotes::phase_line(3*sin((raw(x) - 2)/5) ~ x, 
                   domain(x=-4:4),
                   nix_dyn=FALSE, narrows=15,
                   transform=function(x) x^.75) %>%
  slice_plot(raw(x) - 2 ~ x, color="magenta", alpha=.5)
```

So long as two flows have similar fixed points with the same stability, their trajectories will be much the same. Consequently, studying the fixed points without worrying about the details of the dynamics gives a huge amount of information about the system.

For example, Figure \@ref(fig:many-trajs-1) shows a score of different time series following the solutions from a score of initial conditions. The long-term behaviors for all the time series is similar: they converge to one or another of the stable fixed points.

```{r many-trajs-1, echo=FALSE, fig.cap="Time series from the differential equation $\\partial_t x = f(x)$ starting at many initial conditions. The locations of the three fixed points are marked with horizontal lines. All the solutions convert to one or the other of the two stable fixed points in the system, and depart from the unstable fixed point."}
raw <- rfun( ~ x, seed=920)
Pts <- tibble(
  x = seq(-4, 4, length=100),
  y = raw(x) - 2
)
dynfun <- spliner(y ~ x, Pts)
dynfun <- makeFun(raw(x) - 2 ~ x)
P <- NULL
traj <- list()
xinit <- -3.5
while (xinit <= 3.5) {
  Pts <-trajectory_euler(dx ~ dynfun(x), x=xinit, dt=.01, nsteps=150)
  xinit <- xinit + 0.25

  P <- P %>% gf_line(x ~ t, data = Pts)
}
P %>% gf_hline(yintercept = ~-3.06, color="blue", 
               size=2, alpha=.3) %>%
  gf_hline(yintercept = ~-1.59, color="magenta",
           size=2, alpha=.3) %>%
  gf_hline(yintercept = ~1.06, color="blue",
           size=2, alpha=.3) %>%
  gf_labs(y="Initial condition")
```

It's worth pointing out a consequence of the mathematics of continuous functions: if a system with a continuous dynamical function has a region of state space with two different fixed points, there must be an unstable fixed point in between them. 

## Linearization

You can see in Figure \@ref(fig:many-trajs-1) that many of the solutions approach their final, equilibrium value in an exponential manner. This is particularly true for the solutions with initial conditions very near the stable fixed points. All these solutions are characterized quantitatively by the parameter $a$ in the exponential solution $A e^{a t}$. (Remember, $a < 0$ when there is exponential decay.)

Quantitative knowledge of $a$ is helpful to understand the time scale of the exponential approach to stable fixed points. We can find a numerical value for $a$ for each fixed point by constructing a ***linear approximation*** to the dynamical function near each of the fixed points.

The procedure involves the same principles as introduced in Block 2 for constructing low-order polynomial approximations to functions, but here "low-order" means "first order."

The analysis is done separately for each of the fixed points, so the first step is to find the fixed points, the values $x^\star$ such that $f(x^\star) = 0$.

Recall from Block 2 the Taylor polynomial approximation to a function $f(x)$ centered on a point $x^\star$:
$$f(x) \approx f(x^\star) + \partial_x f(x^\star) \left[x - x^\star\right]$$
When $x^\star$ is a fixed point, $f(x^\star) = 0$ so the approximation is simply $f(x) \approx \partial_x f(x^\star) \left[x - x^\star\right]$. Keep in mind that $\partial_x f(x^\star)$ is the derivative function $\partial_x f$ **evaluated** at the input $x^\star$, so $\partial_x f(x^star)$ is simply a quantity, not a function. Indeed, $\partial_x f(x^star)$ is exactly the quantity $a$ in the exponential solution $e^{a t}$.

This process of constructing the linear approximation $f(x) \approx a \left[x - x^\star\right]$ is called ***linearization***. 

::: {.example data-latex=""}
Consider the first-order differential equation $$\partial_t x = f(x) \equiv r x (x - x/K)$$ where $r$ and $K$ are parameters that are greater than zero. Linearizing the nonlinear function $f(x)$ lets us figure out how fast or slow is the exponential growth or decay of the solutions for initial conditions near the fixed points.

1. There are two fixed points, one at $x_1^\star = 0$ and the other at $x_2^\star = K$. What is the exponential parameter $a$ for each of the fixed points.

2. The derivative (with respect to $x$) $\partial_x f(x)$ can be found with the ***product rule*** from Block 2. It is $$\partial_x f(x) = r\, (1 - x/K) - r\, x\, (1/K)$$

3. Evaluating $\partial_x f(x)$ at the two fixed points $x_1^\star = 0$ and $x_2^\star = K$ gives

$$\partial_x f(x_1^\star) = r\ \ \ \text{and}\ \ \ \partial_x f(x_2^\star) = -r$$
Solutions near $x_1^\star$ will grow exponentially as $e^{r t}$, unstable since $0 < r$. Solutions near $x_2^\star$ will decay toward $x_2^\star$ in an exponential manner as $e^{-r t}$.
:::

::: {.takenote data-latex=""}
It's critical to distinguish carefully between $x^\star$, which is the location of the fixed point being examined, and $x_0$, which is the initial condition of the state, that is, $x(t=0)$.
:::

::: {.example data-latex=""}
$\ $

Let's return to the model of saving for retirement in Chapter \@ref(diff-eq-intro):
$$\partial_t V = r\, V + M\ .$$
The state variable here is named $V$. The dynamical function is $$g(V) = r\, V + M$$ where $r$ is the interest rate (say, 3% per year which is $r=0.03$ per year) and $M$ is the monthly contribution. To keep the units consistent, we set the units of $t$ to be years, of $r$ to be 1/years, of $V$ to be dollars and of $M$ to be dollars-per-year. So a monthly contribution of $1000 would come to 
$M=12000$ dollars-per-year.

Find the amount $V$ that will result from 30 years of savings with an initial condition $V_0 = 0$.

Step i) Find the fixed point. This is a value $V^\star$ such that
$$r\, V^\star + M = 0\ \ \ \implies \ \ \ V^\star = -M/r\ .$$
Step ii) Find the derivative of the dynamical function evaluated at the fixed point: Since $g(V)$ happens to be a straight-line function, we know the derivative is a constant. So $b = \partial_x g(V^\star) = r$.

Step iii) Translate the state variable into $y = V - V^\star$. The dynamics in terms of $y$ are $\partial_t y = b y$, which has an exponential solution $y = A e^{bt}$.

Step iv) $A$ is the initial condition in terms of $y$. This will be $y_0 = V_0 - V^\star$. Since we stated that $V_0 = 0$ (no savings at the start), $y_0 = -V^\star$ and the solution is $$y(t) = -V^\star e^{bt} = \frac{M}{r} e^{rt}\ .$$

Step v) Translate the solution in step (iv) back into terms of $V(t)$. Since $y(t) = V(t) - V^\star$, this will be $V(t) = y(t) + V^\star$ or, $$V(t) = \frac{M}{r} e^{r t} + V^\star = \frac{M}{r} \left[ e^{r t} - 1\right]\ .$$
To get an idea of this retirement plan, that is, $r=3\%$ and $M=12000$ dollars-per-year, let's see how much you'll have after 30 years and 40 years.
```{r}
V <- makeFun((M/r)*(exp(r*t)-1) ~ t, r=0.03, M=12000)
V(30)
V(40)
```
After 40 years of contributions, your retirement account will have almost one-million dollars.

You could have accomplished the same calculation using `integrateODE()`, like this:
```{r}
Soln <- integrateODE(dV ~ r*V + M, V=0, M=12000, r=0.03,  
                     tdur=40)
Soln$V(30)
Soln$V(40)
```
:::

## Bifurcation

We have been using the differential equation $\partial_t x(1-x)$ as a mathematical equation, but the form has important applications in population modeling and ecology. When parameterized, the model becomes
$$\partial_t x = h(x) \equiv r x \left(1 - \frac{x}{K}\right)$$
For $x \ll K$, the dynamics are approximately $\partial_t x = rx$, which is the recipe for ***exponential growth***. Such growth is often seen in small populations. But "small" compared to what? To answer that, look at the situation for $x \approx K$. In this domain, the growth will be much smaller, because $(1 - x/K) \approx 0$. There's a fixed point at $x^\star = K$, and for $K < x$ the time derivative of $x$ is negative. 

In ecology, the population size that can just barely sustain itself without growth or decay is called the ***carrying capacity***. Putting these different behaviors together, $\partial_t x = h(x)$ is a model of growth of a population when the environment has a finite carrying capacity. The pattern of change in such an environment is called ***logistic growth***, but might as well be called "sigmoidal growth." (The function $f(x) = \frac{e^t}{1 + e^t}$ is called the "logistic function.")

In this problem, we're going to build a somewhat more complicated model of an ecosystem, based on the logistic growth model for grass. 

To turn a field of growing grass into an eco**system**, we're going to add grazing cows to the field. A grazing cow has an impact on a field. To simplify, consider a single cow. She eats until she's full, then takes time off to chew the cud with other cows and ruminate on the day's events. But, if grass is very scarce, she may not be able to consume all that she would otherwise eat. She'll be a hungry, ill-fed cow. 

When building a model, start by thinking what you want to use the model for. Imagine that we're interested in *sustainability*, that is, whether the cow/grass ecosystem is stable. And, since cows are raised for a purpose, we'd like to use the model to find out whether the cow would be well fed and how things would change if another cow were added to the field. Sustainability is a question about dynamics. Here, the system would be sustainable if the field produces more grass in a day than the cow (and her herd-mates if any) consumes consumes in a day.

We'll model a cow's consumption as a sigmoidal function consumption(v) of the amount of grass (v -- for "vegetation") available. Like this:

```{r cow-consumption, echo=FALSE, height=3, fig.cap="The amount of vegetation consumed by a cow in a day depends on the amount of vegetation available. At very low levels of vegetation ($v < 1/2$ ton), it's hard to find more to eat, so a slight increase in vegetation doesn't increase consumption by much."}
consumption <- makeFun((beta*v^2/(v0^2 + v^2))~ v, beta=0.1, v0=3)
slice_plot(consumption(v) ~ v, domain(v=c(0,15))) %>%
  gf_labs(y="Consumption (tons/day)", x="v: available biomass (tons)",
          title="Daily consumption by one cow")
```
The overall system is roughly analogous to the rabbit/fox model where we had rabbits as the food and foxes as the consumers. In the rabbit/fox system, we had one differential equation for the growth in the rabbit population density and another for the foxes. The rabbit dynamics consisted of two parts, the natural growth rate in the absence of foxes and the rate at which rabbits are taken by the foxes: $\partial_t r = 0.66\, r - 1.33\, r f$.

We'll model the dynamics of grass in much the same way. In the absence of cows the grass grows in an environment with a limited carrying capacity. (Carrying capacity reflects limits to the amount of water and the amount of sunlight and space.) Taking the carrying capacity of the field as 25 tons of biomass, we'll set the model for $v(t)$ to be 
$$ \partial_t v =  \frac{v}{3} \left(1-\frac{v}{25}\right)\ .$$


We now have two models for two different components of the ecosystem: the growth of vegetation and the daily consumption by a cow. It's time to put those components together into the overall model. But do we have everything we need?

There are potentially two state variables, the amount of vegetation and the number of cows.  To be analogous to that situation, we would need a model for the number of cows in the field. However, the context for the model suggests some changes here. First, the number of cows $n$ in the field is not set by the cow's natural reproduction, it's set by the farmer's decision. As well, at 9 months, a cow's gestation period is long relative to the potential changes in the amount of vegetation. (In contrast, rabbits have a gestation period of 1 month and foxes 2 months.)


The cow's consumption is one part of the dynamics. If there were no grass growing, the dynamics would be $$\partial_t G(v) = - H \times \text{consumption}(v)$$ where $H$ is the number of cows in the herd. `r mark(6330)`


 Subtracting daily consumption from daily growth of grass gives the rate of change of the biomass of grass. 

<p style="text-align:center">
<iframe frameborder="0" height="780px" loading="lazy"
        src="https://maa-statprep.shinyapps.io/Grazing_cows/"
        width="60%">
</iframe>
</p>
        
```{r cow-app, echo=FALSE, out.width="1%", fig.cap = "The graph can be made to display any of three functions:\n\n1. The intrinsic logistic model growth dynamics with no cows.\\2. The total consumption by the herd of cows.\\3. The **net growth**, which is the difference between (1) and (2)."}        
knitr::include_graphics("www/tiny-blank.png")
```



## Exercises 

`r insert_calcZ_exercise("XX.XX", "9aVYdV", "Exercises/dolphin-hang-dish.Rmd")`

`r insert_calcZ_exercise("XX.XX", "136TO6", "Exercises/ash-look-sofa.Rmd")`

`r insert_calcZ_exercise("XX.XX", "cAKQiT", "Exercises/hamster-dive-window.Rmd")`

`r insert_calcZ_exercise("XX.XX", "L6hTUu", "Exercises/pine-win-oven.Rmd")`

`r insert_calcZ_exercise("XX.XX", "61zaad", "Exercises/calf-dive-pot.Rmd")`

`r insert_calcZ_exercise("XX.XX", "9qOKUM", "Exercises/spruce-fall-mug.Rmd")`

`r insert_calcZ_exercise("XX.XX", "owYlop", "Exercises/finch-write-fridge.Rmd")`

