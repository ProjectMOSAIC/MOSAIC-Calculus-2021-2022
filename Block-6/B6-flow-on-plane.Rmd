## Flows on the plane {#flow-on-plane}

<div style="float:right;">[![](www/icons/edit.png)](https://github.com/ProjectMOSAIC/MOSAIC-Calculus/blob/main/Block-6/B6-fixed-points.Rmd)</div>

::: {.underconstruction}
i. Classify fixed points as stable/unstable given the dynamics
i. Identify the dynamics of constant growth
i. Compute Euler solutions (format for expressing the system and the format of the result)
i. Analyze models in application contexts (for example Mayâ€™s Cows - a model of bistability in ecology)


[Last year's daily digitals](https://maa-statprep.shinyapps.io/142Z-DD-17) from DD-15 to about DD-20 
:::

Let's return the rabbit/fox system as an example of flow. Since there are two state quantities, $r$ and $f$, the state space $(r, f)$ is a plane. At each point in the state space, the flow vector gives the direction and speed of motion. Like all vectors, a flow vector has only two properties: the direction and length. The speed of motion is the length of the flow vector.

The flow itself is a ***vector field***. This is an assignment of a vector to each point of the state space. Graphically, we depict a flow field by selecting a grid of points in the state space, finding the flow vector for each grid point, and drawing those vectors positioned at their respective grid points.

```{r rf-flow-2, echo=FALSE, fig.cap="The flow field has a vector at each point in state space but we can draw only a few if the plot is to be legible. Zooming in on a region produces more detail."}
# commands to make the individual plots in the figure
# vectorfield_plot(0.66*r - 1.33*r*f ~ r & f,
#                  -f + r*f ~ r & f,
#                  domain(r=0:2, f=0:1)) %>%
#   gf_rect(.4 + .7 ~ .8 + 1.3, color="magenta", fill=NA) %>%
#   gf_refine(coord_fixed())
# vectorfield_plot(0.66*r - 1.33*r*f ~ r & f,
#                  -f + r*f ~ r & f,
#                  domain(r=.8:1.3, f=.4:.7)) %>% 
#   gf_rect(.4 + .7 ~ .8 + 1.3, color="magenta", size=2, fill=NA) %>%
#   gf_rect(.47 + .53 ~ .95 + 1.02, color="green", fill=NA) %>%
#   gf_refine(coord_fixed())
# vectorfield_plot(0.66*r - 1.33*r*f ~ r & f,
#                  -f + r*f ~ r & f,
#                  domain(r=.95:1.02, f=.47:.53)) %>% 
#   gf_rect(.47 + .53 ~ .95 + 1.02, color="green", size=2, fill=NA) %>%
#   gf_refine(coord_fixed())
knitr::include_graphics("www/rf-zoom.png")
```

Recall from Block 5 that it's conventional to specify a vector by giving a coordinate pair for the tip of the vector with the understanding that the tail is at the origin. For the rabbit/fox system, the tip's coordinate is $\left({\Large\strut} g_r(r, f),\  g_f(r, f)\right)$. This notation is potentially confusing, because the letters $r$ and $f$ appear in so many places. Each each vector in Figure \@ref(fig:rf-flow2) is drawn at a particular point, say $(r=0.96, f=0.48)$. At that point, evaluate the dynamical functions: $g_r(r=0.96, f=0.48) = 0.0207$ and $g_r(r=0.96, f=0.48)= 0.941$. 

<!--

The state space has coordinates $r$ and $f$, and since $r$ and $f$ are quantities with dimension (rabbit density and fox density, respectively). The components of the flow vector have different dimension: rabbit density per time and fox density per time. Still, the direction of the flow vector can be accurately present in state space; it is after all how the state will change. The drawn length of the vector, however, is on a different scale.

-->

A ***fixed point*** of the dynamics is a point in the state space where the dynamical functions both evaluate to zero. It's convenient to mark fixed points as the intersection of zero contours of the dynamical functions. Figure \@ref(fig.rf-nullclines) shows these zero contours (red for rabbits, blue for foxes) laid on top of the flow field. Such zero contours of dynamical functions are called ***nullclines***. (The word means "zero slope". "Null" corresponds to zero and "cline" is the root of words like "incline" or "decline.")

```{r rf-nullclines}
contour_plot(dt_rabbit(r,f) ~ r & f, domain(r=0.2:2, f=0.05:1), 
             contours_at = 0, contour_color = "red",
             labels=FALSE) %>%
  contour_plot(dt_fox(r,f) ~ r & f,
             contours_at = 0, contour_color = "blue",
             labels=FALSE) %>%
  vectorfield_plot(dt_rabbit(r,f) ~ r & f,
                   dt_fox(r,f) ~ r & f,
                   transform=function(x) x^0.3)

```

Due to the nature of fixed points, if the initial condition is at the intersection of the nullclines the state will not change. But is the fixed point stable or unstable.

As you will see, in two and higher dimensional dynamical systems, there is more than one kind of stability and more than one kind of instability. These different kinds of stability and instability have a direct correspondence to different kinds of behavior in real-world systems.

Very near the fixed point, dynamics are approximately linear. We'll return to a quantitative analysis of this in Chapter \@ref(equilibria). Our objective here is to show that there are several generic types of behavior and that the stability of dynamics near the fixed point has to be one of a handful of different types.

```{r}
show_abcd <- function(a, b, c, d, which=c("both", "x", "y"), 
                      show_sign=c(I, sign), pow=0.3) {
  which <- match.arg(which)
  dx <- makeFun(a*x + b*y ~ x & y)
  dy <- makeFun(c*x + d*y ~ x & y)
  
  P <- NULL
  if (which %in% c("both", "x")) {
    P <- P %>% 
      inequality_constraint(dy(x,y) < 0 ~ x&y, 
                            fill="blue", alpha=0.3, 
                            domain(x=-1:1, y=-1:1))
  } 
  if (which %in% c("both", "y")) {
      P <- P %>% inequality_constraint(dx(x,y) < 0 ~ x&y, 
                                       fill="red", alpha=0.3,
                                       domain(x=-1:1, y=-1:1)) 
  }
  P %>% vectorfield_plot((dx(x,y)) ~ x&y, show_sign(dy(x,y)) ~ x & y, transform=function(x) x^pow) %>%
    gf_refine(coord_fixed())
}
```

## Generic behaviors

On a nullcline of a dynamical variable $x$, the $x$-component of the flow must be zero. The flow will point to positive $x$ on one side of the nullcline and negative $x$ on the other. This is really nothing more than saying that on one side of a zero contour the function value is positive and on the other side negative. We'll indicate this on the following diagrams by shading the positive side of the nullcline with the same color as the nullcline itself. Figure \@ref(fig:shaded-nullcline) shows the nullclines of a linear system on separate plots. Notice that flow in the shaded side of the $x$ (red) nullcline the flow always has a positive component to the right. Similarly, in the shaded side of the $y$ (blue) nullcline, the flow always has a positive component to the right. 

```{r shaded-nullcline, echo=FALSE, fig.cap="The nullclines of a linear dynamical system near the fixed point. $x$ nullcline is red, $y$ nullcline is blue", fig.show="hold", out.width="50%"}
show_abcd(.5, 1, 1, -.7, which="y", pow=.2, show_sign=I)
show_abcd(.5, 1, 1, -.7, which="x", pow=.2, show_sign=I)
```

Placing both nullclines on the same plot divides the region near the fixed point into four parts. This is generic behavior. Unless the two nullclines are exactly the same as each other, the two nullclines split the region into four quadrants.

```{r four-parts, echo=FALSE, fig.cap="Four quadrants of linear dynamics near the fixed point."}
show_abcd(.5, 2, 3, -.7, pow=.2, show_sign=I)
```
We can identify the quadrants by their color---white, red, blue, purple. In each quadrant, the "compass direction" of all flow vectors point to one quadrant of the compass: white to the south-west, red to the south-east, blue to the north-west, and purple to the north-east. 

This particular linear flow is unstable. Notice that any initial condition in the purple quadrant will lead to a NE trajectory, away from the fixed point. Similarly, any initial condition in the white quadrant leads to a SW trajectory, again away from the fixed point. For an initial condition in the red or blue quadrants, the flow will take the trajectory into either the white or purple quandrants. The initial part of the trajectory may be towards the fixed point, but as soon as the trajectory crosses into white or purple territory, the trajectory leads away from the fixed point. So, the overall flow is unstable. This particular type of instability, where the initial path might be toward the fixed point but eventually leads away from it, is called a ***saddle***. The flow is analogous to the movement of a marble placed on a horse saddle; it might start to roll toward the center of the saddle, but eventually it will roll off to the side. 

All linear flows will lead to this quadrant structure. Another feature of the structure is that the white quadrant must always be opposite to the purple, and the red opposite to the blue. This allows us to enumerate the different possible types of stability.

A very compact summary of the dynamics shows just the four compass directions and the relative positions of the quadrants.  For instance, 
$$\begin{array}{c|c}
\color{red}{\searrow} & \color{purple}{\nearrow}\\\hline
\color{gray}{\swarrow} & \color{blue}{\nwarrow}
\end{array}\ ,$$
corresponds to the saddle flow seen in the previous flow field.

There are, altogether, eight possible configurations:
$$\begin{array}{cccc}
\text{saddle} & \text{saddle} & \text{saddle} & \text{saddle} \\
\begin{array}{c|c}
\color{red}{\searrow} & \color{purple}{\nearrow}\\\hline
\color{gray}{\swarrow} & \color{blue}{\nwarrow}
\end{array} &


\begin{array}{c|c}
\color{gray}{\swarrow} & \color{red}{\searrow} \\\hline
\color{blue}{\nwarrow} & \color{purple}{\nearrow} 
\end{array} &

\begin{array}{c|c}
\color{blue}{\nwarrow} & \color{gray}{\swarrow}  \\\hline
\color{purple}{\nearrow} & \color{red}{\searrow} 
\end{array} &

\begin{array}{c|c}
 \color{purple}{\nearrow}&   \color{blue}{\nwarrow}\\\hline
\color{red}{\searrow} &  \color{gray}{\swarrow}
\end{array}
\\
\ \\

\begin{array}{c|c}
\color{red}{\searrow} &  \color{gray}{\swarrow}\\\hline
\color{purple}{\nearrow} & \color{blue}{\nwarrow} 
\end{array} &

\begin{array}{c|c}
\color{purple}{\nearrow}& \color{red}{\searrow} \\\hline
   \color{blue}{\nwarrow}&  \color{gray}{\swarrow}
\end{array} &

\begin{array}{c|c}
   \color{blue}{\nwarrow}& \color{purple}{\nearrow} \\\hline
 \color{gray}{\swarrow}& \color{red}{\searrow}
\end{array}& 
\begin{array}{c|c}
   \color{gray}{\swarrow}& \color{blue}{\nwarrow} \\\hline
 \color{red}{\searrow}& \color{purple}{\nearrow}
\end{array}\\
\text{center} & \text{orbit} & \text{source} & \text{orbit}
\end{array}
$$

***Saddles*** are unstable, although the trajectory might approach the fixed point at first. A ***source*** is unstable; any trajectory heads away from the fixed point. A ***center*** is stable; any trajectory heads toward the fixed point.

As for the orbits, one in a clockwise direction and the other counter-clockwise, we can't yet say from this simple theory whether they are stable or unstable. The orbit we have already met, the rabbit-fox dynamics, has counter-clockwise trajectories that form closed loops. This is called ***neutral stability***. 

```{r rf-orbit, echo=FALSE, fig.cap="The rabbit/fox system is an orbit that is neutrally stable."}
traj1 <- integrateODE(dr ~ dt_rabbit(r, f), 
                      df ~ dt_fox(r,f), r=1.5, f=.25,
                      tdur=7.5
                      )
traj2 <- integrateODE(dr ~ dt_rabbit(r, f), 
                      df ~ dt_fox(r,f), r=1, f=.33,
                      tdur=7.5)
traj_plot(f(t) ~ r(t), traj1, inherit=FALSE) %>%
  traj_plot(f(t) ~ r(t), traj2, inherit=FALSE) %>%
inequality_constraint(dt_rabbit(r, f) < 0 ~ r&f, 
                            fill="red", alpha=0.3, 
                            domain(r=.1:2, f=0.1:1)) %>%
  inequality_constraint(dt_fox(r, f) < 0 ~ r&f, 
                            fill="blue", alpha=0.3, 
                            domain(r=.1:2, f=0.1:1)) %>%
  vectorfield_plot(dt_rabbit(r,f) ~ r & f,
                   dt_fox(r,f) ~ r & f,
                   transform=function(x) x^0.3) %>%
  gf_lims(x = c(.35,2), y=c(0,1.1))
  
  

```

To start, we'll modify the plot of nullclines to make clear 

show_abcd(-.5, -1, 1, .7)
show_abcd(-1, -.5, -.2, -.7)
show_abcd(1, .5, -.2, -.7)
show_abcd(-1, -.5, .2, .7)
show_abcd(1, .5, .2, .7)
```



Look carefully at the flow near the nullclines. Near the fox (blue) nullcline, the flow arrows are always horizontal. That's because $\partial_t f$ is zero on the nullcline, by definition. So any flow on the nullcline can only point in the positive or negative rabbit direction, with zero fox component. 

Similarly, near the rabbit (red)



$$\partial_t r = g_r(r, f) = \alpha r - \beta r f\\
\partial_t f = g_f(r, f) = - \delta f + \gamma r f$$

A fixed point in a second-order system exists at a state where both of the differential equations evaluate to zero. This amounts These simple dynamical functions can be manipulated algebraically to show that there is one fixed point:

$$\text{zeros for}\ r:\ \ \alpha r - \beta r f = 0 \ \ \ \implies\ \ \ f^\star = \frac{\alpha}{\beta}\\
\ \\
\text{zeros for}\ f:\ \ - \delta f + \gamma r f = 0 \ \ \ \implies \ \ \ r^\star = \frac{\gamma}{\delta}$$
We were able to solve the above equations


More generally, considering that the dynamical functions have two inputs, $r$, and $f$, we can see where each of the functions is zero by looking at the zero contour of each function individually. Where the zero contours cross, there is a fixed point.  Figure \@ref(fig:rabbit-fox-nullclines) shows the situation for the rabbit/fox system. These zero contours are called ***nullclines***. At any point on the rabbit nullcline, the flow arrows have zero component in the rabbit direction in state space. Similarly, at any point on the fox nullcline, the flow field has zero component in the fox direction.



```{r rabbit-fox-nullclines, echo=FALSE, fig.cap="Flow field for the rabbit/fox system. The rabbit nullcline is magenta, the fox nullcline is blue." } 
contour_plot(0.66*r - 1.33*r*f ~ r & f, domain(r=.1:2, f=0.05:1), contours_at = 0, contour_color = "magenta", filled = FALSE, labels=FALSE) %>%
  contour_plot(-f + f*r ~ r & f, contours_at=0, contour_color="blue", filled=FALSE, labels=FALSE ) %>%
vectorfield_plot(0.66*r - 1.33*r*f ~ r & f, 
                 1*f*r -1*f ~ r & f, 
                 domain(r=.1:2, f=0.05:1), npts=20, 
                 transform=I) %>%
  gf_labs(x="Rabbit density", y="Fox density")
```




## Stability

hurricanes, tornados, orbits, sand dunes and beach ripples, Galloping Gurdy, ..., orbit around Lagrange point, 

## Linearization




::: {.intheworld data-latex=""}
Given a choice between a numerical and a symbolic solution to exactly the same problem, the symbolic solution is generally better: it's exact and it can incorporate parameters symbolically.


> *"Far better an approximate answer to the right question, which is often vague, than an exact answer to the wrong question, which can always be made precise."* -- John Tukey (1915-2000)
:::



### Tree example

A tree provides a simple example of equilibrium. A living tree grows slowly, with essentially no change from day to day. The tree is usually in equilibrium with its surroundings. But there are disruptions that can place the tree out of equilibrium. The wind is a familiar disruption, changing the dynamics so that the tree no longer stands straight and still; it sways in the wind. A severe storm or a chain saw creates an opportunity for bigger disruption, removing the fixed point of upright posture and replacing it with an entirely different sort of fixed point. The steady, slow process of rot can weaken the equilibrium to the point where it no longer exists or is too weak to withstand the wind. The tree falls.

Mathematics provides several concepts for thinking about equilibrium and the loss of equilibrium. The idea of a **fixed point** is at the center of things. The idea of disruption also has a mathematical equivalent called "forcing." The slow change (as in the rot of a tree) leading to a dramatic, sometimes sudden, collapse is represented by a "bifurcation." We'll explore forcing and bifurcation later, when we've developed better tools and ways of thinking to understand dynamics.



Previously, we examined the stability of fixed points by using iteration: start at an initial condition arbitrarily close (but not exactly on!) a fixed point and see if the trajectory tends toward or away from the fixed point.

Now we'll look at stability another way, by considering the shape of of the dynamical function near a fixed point. At this point in CalcZ, you're aware that "near" suggests local, and that we routinely model (continuous) functions in terms of the value at a point, the value of the derivative at the point, and the value of the 2nd derivative at the point.


